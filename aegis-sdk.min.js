!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Aegis=t()}("undefined"!=typeof self?self:this,function(){"use strict";class e{constructor(e){this.apiKey=e.apiKey,this.baseURL=e.baseURL||"https://05card1j5b.execute-api.ap-south-1.amazonaws.com/prod",this.accessToken=null,this.refreshToken=null,this.user=null,this.tokenExpiry=null,this.listeners={login:[],logout:[],tokenRefresh:[],error:[]},this.refreshInterval=null,this.setupTokenRefresh()}on(e,t){this.listeners[e]&&this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(e=>e(t))}async request(e,t={}){const n=`${this.baseURL}${e}`,s={"Content-Type":"application/json",...t.headers};this.apiKey&&(s["X-API-Key"]=this.apiKey),this.accessToken&&!t.skipAuth&&(s.Authorization=`Bearer ${this.accessToken}`);try{const e=await fetch(n,{method:t.method||"GET",headers:s,body:t.body?JSON.stringify(t.body):void 0,...t.fetchOptions}),r=await e.json();if(!e.ok)throw new Error(r.message||`HTTP ${e.status}`);return r}catch(t){throw this.emit("error",{error:t,endpoint:e}),t}}async login(e,t){try{const n=await this.request("/auth/login",{method:"POST",body:{email:e,password:t},skipAuth:!0});return this.setTokens(n.data),this.emit("login",this.user),n.data}catch(e){throw new Error(`Login failed: ${e.message}`)}}async register(e){try{return(await this.request("/auth/register",{method:"POST",body:e,skipAuth:!0})).data}catch(e){throw new Error(`Registration failed: ${e.message}`)}}async logout(){try{this.accessToken&&await this.request("/auth/logout",{method:"POST"})}catch(e){console.warn("Logout request failed:",e.message)}finally{this.clearTokens(),this.emit("logout")}}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");try{const e=await this.request("/auth/refresh",{method:"POST",body:{refresh_token:this.refreshToken},skipAuth:!0});return this.setTokens(e.data),this.emit("tokenRefresh",this.user),e.data}catch(e){throw this.clearTokens(),new Error(`Token refresh failed: ${e.message}`)}}async startWebAuthnRegistration(){try{const e=await this.request("/auth/webauthn/register/start",{method:"POST"}),t=await navigator.credentials.create({publicKey:e.data.options});return await this.completeWebAuthnRegistration(t)}catch(e){throw new Error(`WebAuthn registration failed: ${e.message}`)}}async completeWebAuthnRegistration(e){const t={id:e.id,rawId:Array.from(new Uint8Array(e.rawId)),response:{attestationObject:Array.from(new Uint8Array(e.response.attestationObject)),clientDataJSON:Array.from(new Uint8Array(e.response.clientDataJSON))},type:e.type};return await this.request("/auth/webauthn/register/complete",{method:"POST",body:{credential:t}})}async startWebAuthnLogin(){try{const e=await this.request("/auth/webauthn/login/start",{method:"POST",skipAuth:!0}),t=await navigator.credentials.get({publicKey:e.data.options});return await this.completeWebAuthnLogin(t)}catch(e){throw new Error(`WebAuthn login failed: ${e.message}`)}}async completeWebAuthnLogin(e){const t={id:e.id,rawId:Array.from(new Uint8Array(e.rawId)),response:{authenticatorData:Array.from(new Uint8Array(e.response.authenticatorData)),clientDataJSON:Array.from(new Uint8Array(e.response.clientDataJSON)),signature:Array.from(new Uint8Array(e.response.signature)),userHandle:e.response.userHandle?Array.from(new Uint8Array(e.response.userHandle)):null},type:e.type},n=await this.request("/auth/webauthn/login/complete",{method:"POST",body:{assertion:t},skipAuth:!0});return this.setTokens(n.data),this.emit("login",this.user),n.data}async enableMFA(){return await this.request("/auth/mfa/enable",{method:"POST"})}async verifyMFA(e){return await this.request("/auth/mfa/verify",{method:"POST",body:{code:e}})}async disableMFA(e){return await this.request("/auth/mfa/disable",{method:"POST",body:{code:e}})}async forgotPassword(e){return await this.request("/auth/forgot-password",{method:"POST",body:{email:e},skipAuth:!0})}async resetPassword(e,t){return await this.request("/auth/reset-password",{method:"POST",body:{token:e,new_password:t},skipAuth:!0})}async getProfile(){return await this.request("/auth/profile")}async updateProfile(e){return await this.request("/auth/profile",{method:"PATCH",body:e})}setTokens(e){this.accessToken=e.access_token,this.refreshToken=e.refresh_token,this.user=e.user,this.tokenExpiry=Date.now()+1e3*e.expires_in,"undefined"!=typeof localStorage&&(localStorage.setItem("aegis_access_token",this.accessToken),localStorage.setItem("aegis_refresh_token",this.refreshToken),localStorage.setItem("aegis_user",JSON.stringify(this.user)),localStorage.setItem("aegis_token_expiry",this.tokenExpiry.toString())),this.setupTokenRefresh()}clearTokens(){this.accessToken=null,this.refreshToken=null,this.user=null,this.tokenExpiry=null,this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null),"undefined"!=typeof localStorage&&(localStorage.removeItem("aegis_access_token"),localStorage.removeItem("aegis_refresh_token"),localStorage.removeItem("aegis_user"),localStorage.removeItem("aegis_token_expiry"))}loadTokensFromStorage(){if("undefined"==typeof localStorage)return!1;const e=localStorage.getItem("aegis_access_token"),t=localStorage.getItem("aegis_refresh_token"),n=localStorage.getItem("aegis_user"),s=localStorage.getItem("aegis_token_expiry");return!!(e&&t&&n&&s)&&(this.accessToken=e,this.refreshToken=t,this.user=JSON.parse(n),this.tokenExpiry=parseInt(s),!(Date.now()>=this.tokenExpiry)||(this.clearTokens(),!1)&&(this.setupTokenRefresh(),!0))}setupTokenRefresh(){this.refreshInterval&&clearInterval(this.refreshInterval),this.tokenExpiry&&(e=>{e>0&&(this.refreshInterval=setTimeout(async()=>{try{await this.refreshAccessToken()}catch(e){this.emit("error",{error:e,type:"token_refresh"})}},e))})(this.tokenExpiry-Date.now()-6e4)}isAuthenticated(){return!!(this.accessToken&&this.tokenExpiry&&Date.now()<this.tokenExpiry)}getUser(){return this.user}getAccessToken(){return this.accessToken}isWebAuthnSupported(){return!!(navigator.credentials&&navigator.credentials.create&&navigator.credentials.get)}}return{create:function(t){if(!t||!t.apiKey)throw new Error("Aegis SDK requires an API key");const n=new e(t);return n.loadTokensFromStorage(),n},AegisSDK:e}});